# DIN (Deep Interest Network) æ¨¡å‹

## æ¦‚è¿°

DIN (Deep Interest Network) æ˜¯ä¸€ç§ç”¨äºæ¨èç³»ç»Ÿçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œé€šè¿‡æ³¨æ„åŠ›æœºåˆ¶åŠ¨æ€å»ºæ¨¡ç”¨æˆ·å…´è¶£ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†ç”¨æˆ·è¡Œä¸ºåºåˆ—å’Œç‰¹å¾äº¤äº’ã€‚

## æ¨¡å‹ç‰¹ç‚¹

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿
1. **æ³¨æ„åŠ›æœºåˆ¶**: æ ¹æ®å€™é€‰ç‰©å“åŠ¨æ€è°ƒæ•´ç”¨æˆ·å†å²è¡Œä¸ºåºåˆ—çš„æƒé‡
2. **åºåˆ—å»ºæ¨¡**: æ›´å¥½åœ°æ•æ‰ç”¨æˆ·å…´è¶£çš„å¤šæ ·æ€§å’Œæ¼”åŒ–
3. **ç‰¹å¾äº¤äº’**: å­¦ä¹ ç”¨æˆ·ç‰¹å¾ã€ç‰©å“ç‰¹å¾å’Œè¡Œä¸ºåºåˆ—ä¹‹é—´çš„å¤æ‚äº¤äº’
4. **å¤šæºèåˆ**: æ•´åˆ CFã€Keywordã€YouTube DNN ä¸‰ç§å¬å›ç»“æœ

### ğŸ—ï¸ æ¶æ„ç»„ä»¶
1. **Embedding Layer**: å°†ç¨€ç–ç‰¹å¾è½¬æ¢ä¸ºç¨ å¯†å‘é‡
2. **Attention Layer**: è®¡ç®—å€™é€‰ç‰©å“ä¸å†å²è¡Œä¸ºçš„æ³¨æ„åŠ›æƒé‡
3. **Pooling Layer**: åŠ æƒèšåˆå†å²è¡Œä¸ºåºåˆ—
4. **MLP Layers**: å¤šå±‚æ„ŸçŸ¥æœºè¿›è¡Œæœ€ç»ˆé¢„æµ‹

## æ–‡ä»¶ç»“æ„

```
src/rank/din/
â”œâ”€â”€ din_model.py          # DIN æ¨¡å‹å®šä¹‰
â”œâ”€â”€ dataset_din.py        # æ•°æ®é›†å¤„ç†
â”œâ”€â”€ train_din.py          # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ infer_din.py          # æ¨ç†è„šæœ¬
â”œâ”€â”€ evaluate_din.py       # è¯„ä¼°è„šæœ¬
â””â”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¿«é€Ÿå¼€å§‹

```bash
# è¿è¡Œå®Œæ•´çš„ DIN æµç¨‹
./run_din.sh
```

### 2. åˆ†æ­¥æ‰§è¡Œ

#### è®­ç»ƒæ¨¡å‹
```bash
export PYTHONPATH=/path/to/project:$PYTHONPATH
python src/rank/din/train_din.py
```

#### è¿è¡Œæ¨ç†
```bash
python src/rank/din/infer_din.py
```

#### è¯„ä¼°æ¨¡å‹
```bash
python src/rank/din/evaluate_din.py
```

## é…ç½®å‚æ•°

### æ¨¡å‹å‚æ•°
- `embed_dim`: åµŒå…¥ç»´åº¦ (é»˜è®¤: 16)
- `max_seq_len`: æœ€å¤§åºåˆ—é•¿åº¦ (é»˜è®¤: 10)
- `hidden_dims`: MLPéšè—å±‚ç»´åº¦ (é»˜è®¤: [32, 16])
- `learning_rate`: å­¦ä¹ ç‡ (é»˜è®¤: 0.001)
- `batch_size`: æ‰¹æ¬¡å¤§å° (é»˜è®¤: 64)
- `num_epochs`: è®­ç»ƒè½®æ•° (é»˜è®¤: 3)

### æ•°æ®å‚æ•°
- `cutoff_days`: æ ‡ç­¾çª—å£å¤©æ•° (é»˜è®¤: 7)
- `train_days`: è®­ç»ƒæ•°æ®çª—å£å¤©æ•° (é»˜è®¤: 30) - ä¸å¬å›æ¨¡å‹ä¸€è‡´
- `neg_pos_ratio`: è´Ÿæ ·æœ¬æ¯”ä¾‹ (é»˜è®¤: 2)
- `max_samples`: æœ€å¤§æ ·æœ¬æ•° (é»˜è®¤: 10000)
- `max_users`: æœ€å¤§ç”¨æˆ·æ•° (é»˜è®¤: 1000)

## è¾“å…¥ç‰¹å¾

### ç”¨æˆ·ç‰¹å¾
- **ç±»åˆ«ç‰¹å¾**: gender, age_range, city, cluster_id
- **æ•°å€¼ç‰¹å¾**: recency, frequency, monetary, rfm_score, actions_per_active_day_30d, æ—¶é—´åå¥½ç­‰

### ç‰©å“ç‰¹å¾
- **ç±»åˆ«ç‰¹å¾**: category, brand
- **æ•°å€¼ç‰¹å¾**: price, rating, review_count

### å¬å›åˆ†æ•°
- CF åˆ†æ•°
- Keyword åˆ†æ•°
- YouTube DNN åˆ†æ•°

### ç”¨æˆ·è¡Œä¸ºåºåˆ—
- å†å²ç‚¹å‡»ç‰©å“åºåˆ—
- åºåˆ—é•¿åº¦: æœ€å¤š50ä¸ªç‰©å“
- æ³¨æ„åŠ›æƒé‡: æ ¹æ®å€™é€‰ç‰©å“åŠ¨æ€è°ƒæ•´

## è¾“å‡ºç»“æœ

### è®­ç»ƒè¾“å‡º
- `din_model.pt`: è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡
- `din_config.json`: æ¨¡å‹é…ç½®
- `din_loss_log.csv`: è®­ç»ƒæŸå¤±æ—¥å¿—

### æ¨ç†è¾“å‡º
- `din_infer.csv`: æ¨èç»“æœ
  - user_id: ç”¨æˆ·ID
  - item_id: ç‰©å“ID
  - rank: æ’åºä½ç½®
  - din_score: DINæ¨¡å‹åˆ†æ•°
  - cf_score: CFåˆ†æ•°
  - keyword_score: Keywordåˆ†æ•°
  - dnn_score: YouTube DNNåˆ†æ•°

### è¯„ä¼°è¾“å‡º
- `din_eval_metrics.csv`: è¯„ä¼°æŒ‡æ ‡
  - Recall@20: å¬å›ç‡
  - Precision@20: ç²¾ç¡®ç‡
  - HitRate@20: å‘½ä¸­ç‡
  - NDCG@20: å½’ä¸€åŒ–æŠ˜æ‰£ç´¯ç§¯å¢ç›Š

## ä¸ Meta-Ranker å¯¹æ¯”

DIN æ¨¡å‹ç›¸æ¯”ä¼ ç»Ÿçš„ Meta-Ranker æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **åºåˆ—å»ºæ¨¡**: èƒ½å¤Ÿåˆ©ç”¨ç”¨æˆ·å†å²è¡Œä¸ºåºåˆ—ä¿¡æ¯
2. **æ³¨æ„åŠ›æœºåˆ¶**: åŠ¨æ€è°ƒæ•´ä¸åŒå†å²è¡Œä¸ºçš„é‡è¦æ€§
3. **æ·±åº¦å­¦ä¹ **: èƒ½å¤Ÿå­¦ä¹ æ›´å¤æ‚çš„ç‰¹å¾äº¤äº’
4. **ç«¯åˆ°ç«¯è®­ç»ƒ**: æ•´ä¸ªæ¨¡å‹å¯ä»¥ç«¯åˆ°ç«¯ä¼˜åŒ–

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¾èµ–**: éœ€è¦å…ˆè¿è¡Œèåˆå¬å› (`fusion_recall.py`) ç”Ÿæˆè¾“å…¥æ•°æ®
2. **å†…å­˜éœ€æ±‚**: åºåˆ—æ•°æ®éœ€è¦è¾ƒå¤šå†…å­˜ï¼Œå»ºè®®è°ƒæ•´ `batch_size`
3. **è®­ç»ƒæ—¶é—´**: æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®ä½¿ç”¨ GPU
4. **ç‰¹å¾å·¥ç¨‹**: ç¡®ä¿æ‰€æœ‰ç‰¹å¾éƒ½å·²æ­£ç¡®é¢„å¤„ç†å’Œç¼–ç 

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**: å‡å° `batch_size` æˆ– `max_seq_len`
2. **è®­ç»ƒä¸æ”¶æ•›**: è°ƒæ•´å­¦ä¹ ç‡æˆ–å¢åŠ è®­ç»ƒè½®æ•°
3. **ç‰¹å¾ç¼ºå¤±**: æ£€æŸ¥æ•°æ®é¢„å¤„ç†æ˜¯å¦æ­£ç¡®
4. **æ¨¡å‹åŠ è½½å¤±è´¥**: ç¡®ä¿æ¨¡å‹æ–‡ä»¶è·¯å¾„æ­£ç¡®

### æ€§èƒ½ä¼˜åŒ–

1. **ä½¿ç”¨ GPU**: è®¾ç½® `CUDA_VISIBLE_DEVICES`
2. **æ•°æ®å¹¶è¡Œ**: ä½¿ç”¨ `DataParallel` æˆ– `DistributedDataParallel`
3. **æ··åˆç²¾åº¦**: ä½¿ç”¨ `torch.cuda.amp` åŠ é€Ÿè®­ç»ƒ
4. **æ•°æ®ç¼“å­˜**: å°†é¢„å¤„ç†æ•°æ®ç¼“å­˜åˆ°ç£ç›˜

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰ç‰¹å¾
å¯ä»¥åœ¨ `dataset_din.py` ä¸­æ·»åŠ æ–°çš„ç‰¹å¾ç±»å‹ï¼š

```python
# æ·»åŠ æ–°çš„ç±»åˆ«ç‰¹å¾
self.user_cate_dims["new_feature"] = feature_dim

# æ·»åŠ æ–°çš„æ•°å€¼ç‰¹å¾
self.user_numeric_cols.append("new_numeric_feature")
```

### æ¨¡å‹æ”¹è¿›
å¯ä»¥åœ¨ `din_model.py` ä¸­ä¿®æ”¹æ¨¡å‹æ¶æ„ï¼š

```python
# ä¿®æ”¹æ³¨æ„åŠ›å±‚
self.attention_layer = CustomAttentionLayer(embed_dim)

# æ·»åŠ æ–°çš„ç½‘ç»œå±‚
self.custom_layer = nn.Linear(embed_dim, embed_dim)
```

## å‚è€ƒæ–‡çŒ®

1. Zhou, G., et al. "Deep Interest Network for Click-Through Rate Prediction." KDD 2018.
2. Zhou, G., et al. "Deep Interest Evolution Network for Click-Through Rate Prediction." AAAI 2019.
3. Pi, Q., et al. "Search-based User Interest Modeling with Lifelong Sequential Behavior Data for Click-Through Rate Prediction." CIKM 2020.
